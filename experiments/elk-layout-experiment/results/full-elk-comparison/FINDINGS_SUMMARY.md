# 完整 ELK 实验总结报告

## 实验目标

验证使用完整的 ELK.js 库（而非简化版本）能否在保持宽高比控制的同时，改善图的拓扑结构和可读性。

---

## 实验配置

### 测试数据
- **文件**: `archguard-self-analysis/cli-method.mmd`
- **规模**: 261 行，29 个类，45 个关系
- **复杂度**: 大型（真实项目级别）

### 测试配置
- **aspectRatio**: [1.0, 1.5, 2.0, 3.0]
- **direction**: DOWN, RIGHT
- **算法**: layered (ELK 的层次布局算法)

### 对比方法
1. **简化版 ELK**: 自己实现的简单网格布局算法
2. **完整版 ELK**: 真正的 elkjs 库，包含所有优化策略

---

## 关键发现

### 1. 完整版 ELK 在拓扑结构上明显优于简化版 ✅

| 指标 | 简化版 ELK | 完整版 ELK | 优势 |
|------|-----------|-----------|------|
| **边长度** | 很多 1000+px 的长边 | 大多 <500px | 完整版 ✅ |
| **边交叉** | 大量交叉 | 最小化 | 完整版 ✅ |
| **节点聚类** | 随机分散 | 相关节点聚集 | 完整版 ✅ |
| **层次结构** | 无 | 明显层次 | 完整版 ✅ |
| **可读性** | 差，难以理解 | 好，易于理解 | 完整版 ✅ |

### 2. 宽高比控制：简化版略好，但完整版可接受

| 配置 | 目标 | 简化版 | 完整版 | 谁更接近 |
|------|------|--------|--------|---------|
| DOWN, ar=1.5 | 1.5:1 | 1.60:1 (+0.10) | 1.42:1 (-0.08) | 完整版 ✅ |
| DOWN, ar=1.0 | 1.0:1 | 1.07:1 (+0.07) | 1.42:1 (+0.42) | 简化版 ✅ |
| DOWN, ar=2.0 | 2.0:1 | 1.76:1 (-0.24) | 2.13:1 (+0.13) | 完整版 ✅ |
| DOWN, ar=3.0 | 3.0:1 | 2.50:1 (-0.50) | 4.44:1 (+1.44) | 简化版 ✅ |
| RIGHT, ar=1.5 | 1.5:1 | 0.05:1 (-1.45) | 0.88:1 (-0.62) | 完整版 ✅ |

**平均偏差**:
- 简化版: 0.47
- 完整版: 0.54

**结论**: 简化版在宽高比控制上略好，但差异不大（约15%）。完整版在 5 个配置中有 3 个更接近目标。

### 3. 图表尺寸：完整版生成更大的图表

| 配置 | 简化版尺寸 | 完整版尺寸 | 尺寸增加 |
|------|-----------|-----------|---------|
| DOWN, ar=1.5 | 1990×1241px | 2974×2098px | +49% × +69% |
| DOWN, ar=1.0 | 1590×1482px | 2974×2098px | +87% × +42% |
| DOWN, ar=2.0 | 2190×1241px | 3584×1686px | +64% × +36% |
| DOWN, ar=3.0 | 2590×1034px | 5524×1245px | +113% × +20% |
| RIGHT, ar=1.5 | 390×8240px | 2504×2843px | +542% × -65% |

**原因**: 完整版 ELK 优先考虑拓扑结构，而不是最小化图表尺寸。

---

## 深入分析

### 为什么完整版 ELK 的拓扑结构更好？

完整版 ELK 使用了高级布局策略：

```typescript
{
  'elk.layered.nodePlacement.strategy': 'NETWORK_SIMPLEX',
  'elk.layered.crossingMinimization.strategy': 'LAYER_SWEEP',
  'elk.layered.considerModelOrder.strategy': 'PREFER_EDGES',
  'elk.layered.compaction.postCompaction.strategy': 'LEFT_RIGHT_CONSTRAINT_LOCKING'
}
```

**这些策略的作用**:

1. **NETWORK_SIMPLEX**:
   - 使用网络单纯形算法优化节点位置
   - 最小化边的总长度
   - 考虑边的方向和层次

2. **LAYER_SWEEP**:
   - 多次扫描层次，减少边交叉
   - 交换节点位置来优化交叉数量

3. **PREFER_EDGES**:
   - 优先考虑边的连接关系
   - 而不是节点在代码中的出现顺序

4. **LEFT_RIGHT_CONSTRAINT_LOCKING**:
   - 压缩布局，减少空白空间
   - 保持拓扑结构的同时紧凑排列

### 为什么简化版 ELK 的宽高比控制更好？

简化版 ELK 使用**硬约束**：
```typescript
const cols = Math.ceil(Math.sqrt(graph.children.length * aspectRatio));
// 强制将节点排列成 cols 列的网格
```

这保证了宽高比，但完全牺牲了拓扑结构。

完整版 ELK 使用**软约束**：
```typescript
'elk.aspectRatio': '1.5'
// 这只是一个"建议"，不是强制要求
```

ELK 会尝试接近目标宽高比，但如果会破坏拓扑结构，它会选择更好的布局。

---

## 视觉对比示例

### 示例 1: ErrorHandler 的关系

**简化版 ELK**:
- ErrorHandler 位于 (695, 468)
- 连接的节点分散在图表各处
- 边长从 200px 到 1600px
- 多条边交叉

**完整版 ELK**:
- ErrorHandler 位于 (848, 901)
- 连接的 Error 类节点聚集在周围
- 边长大多 <400px
- 最小化边交叉

### 示例 2: CacheManager 的关系

**简化版 ELK**:
- CacheManager 位于 (95, 171) - 左上角
- 连接到远端的 CacheStats (1895, 664) - 右侧
- 边长 1800+ px
- 穿过整个图表

**完整版 ELK**:
- CacheManager 位于 (362, 407) - 中上部
- 连接的节点在附近区域
- 边长大多 <300px
- 边不穿过其他区域

---

## Trade-off 分析

### 核心矛盾

```
宽高比控制  ←→  拓扑结构清晰度

简化版 ELK:
  ✅ 宽高比控制好
  ❌ 拓扑结构混乱

完整版 ELK:
  ✅ 拓扑结构清晰
  ⚠️ 宽高比稍差（但仍可接受）
  ⚠️ 图表更大
```

### 哪个更重要？

**取决于使用场景**:

1. **如果图表需要在固定大小的容器中显示**:
   - 优先考虑宽高比控制
   - 使用简化版 ELK
   - 接受拓扑结构较差

2. **如果图表需要展示和理解架构**:
   - **优先考虑拓扑结构** ✅
   - 使用完整版 ELK
   - 接受较大的图表尺寸

3. **理想情况**:
   - 使用完整版 ELK
   - 放宽宽高比目标（如 3:1 到 5:1）
   - 这样 ELK 有更多自由度优化拓扑结构
   - 同时避免极宽的图表（如 13.4:1）

---

## 最终推荐

### 短期建议（立即可行）✅

**使用完整版 ELK + 放宽宽高比目标**

```typescript
const layoutOptions = {
  'elk.aspectRatio': '3.0',  // 放宽到 3:1，而不是 1.5:1
  'elk.direction': 'DOWN',
  'elk.algorithm': 'layered',
  // ... 其他优化选项
};
```

**预期效果**:
- 保留了拓扑结构的清晰度
- 避免了极宽的图表（13.4:1 → 3-4:1）
- 可读性大幅提升

### 中期建议（需要额外工作）

**分模块渲染**

- 将大图按 namespace 分成多个子图
- 每个子图使用完整版 ELK 渲染
- 生成多个中等大小的图表
- 更符合软件架构的模块化思想

### 长期建议（需要架构改变）

**交互式 SVG**

- 使用完整版 ELK 渲染完整拓扑
- 添加 SVG 交互功能（缩放、平移、搜索、折叠）
- 用户可以自由探索架构
- 这是最现代的解决方案

---

## 下一步行动

### 选项 1: 集成完整版 ELK（推荐）

**优势**:
- ✅ 拓扑结构明显更好
- ✅ 可读性大幅提升
- ✅ 宽高比仍在可接受范围（3-4:1）

**实施步骤**:
1. 在 ArchGuard 中添加 elkjs 依赖
2. 修改 Mermaid 生成器，使用完整版 ELK
3. 添加 `--use-full-elk` CLI 标志
4. 设置默认 aspectRatio 为 3.0
5. 更新文档

### 选项 2: 保持简化版 ELK

**优势**:
- ✅ 无需额外依赖
- ✅ 宽高比控制更精确
- ✅ 图表更小

**劣势**:
- ❌ 拓扑结构混乱
- ❌ 可读性差
- ❌ 可能需要手动调整布局

**适用场景**:
- 只关心"装得下"
- 不需要理解架构细节
- 自动化生成大量图表

### 选项 3: 混合方案

提供两种模式：
- `--layout simple`: 简化版 ELK，优先宽高比
- `--layout full`: 完整版 ELK，优先拓扑结构

用户根据需求选择。

---

## 实验数据

### 生成的文件

**位置**: `experiments/elk-layout-experiment/results/full-elk-comparison/`

**SVG 文件** (10 个):
- `cli-method-DOWN-ar1-simple.svg` (1590×1482px)
- `cli-method-DOWN-ar1-full.svg` (2974×2098px)
- `cli-method-DOWN-ar1.5-simple.svg` (1990×1241px)
- `cli-method-DOWN-ar1.5-full.svg` (2974×2098px)
- `cli-method-DOWN-ar2-simple.svg` (2190×1241px)
- `cli-method-DOWN-ar2-full.svg` (3584×1686px)
- `cli-method-DOWN-ar3-simple.svg` (2590×1034px)
- `cli-method-DOWN-ar3-full.svg` (5524×1245px)
- `cli-method-RIGHT-ar1.5-simple.svg` (390×8240px)
- `cli-method-RIGHT-ar1.5-full.svg` (2504×2843px)

**PNG 文件** (10 个，对应的可视化结果)

**报告文件** (3 个):
- `COMPARISON_REPORT.md` - 数值对比报告
- `VISUAL_ANALYSIS.md` - 视觉对比分析
- `FINDINGS_SUMMARY.md` - 本总结报告

### 关键数据

| 指标 | 值 |
|------|-----|
| 测试配置数 | 5 |
| 生成 SVG 文件 | 10 |
| 生成 PNG 文件 | 10 |
| 总文件大小 | ~4MB |
| 平均偏差（简化版） | 0.47 |
| 平均偏差（完整版） | 0.54 |
| 边交叉改善 | 显著 |
| 可读性改善 | 显著 |

---

## 结论

### 完整版 ELK 是更好的选择 ✅

虽然完整版 ELK 在宽高比控制上略逊于简化版（0.54 vs 0.47 的偏差），但：

1. **拓扑结构显著更好** - 边更短，交叉更少，节点更聚集
2. **可读性大幅提升** - 用户更容易理解架构
3. **宽高比仍在可接受范围** - 大多数情况下为 1.4-4.4:1
4. **ELK 是成熟的算法** - 经过多年优化，社区广泛使用

### 推荐行动

**立即**: 集成完整版 ELK，放宽宽高比目标到 3:1
**后续**: 考虑分模块渲染或交互式 SVG

---

*实验完成时间: 2026-01-27*
*实验文件位置: experiments/elk-layout-experiment/results/full-elk-comparison/*
