# å…³ç³»çº¿æ··ä¹±é—®é¢˜ - å®Œæ•´åˆ†æä¸æ”¹è¿›æ–¹æ¡ˆ

## ğŸ“‹ æ‰§è¡Œæ‘˜è¦

**é—®é¢˜**: ELK å®éªŒç”Ÿæˆçš„æ¶æ„å›¾ä¸­ï¼Œå…³ç³»çº¿æ˜¾å¾—å¾ˆæ··ä¹±

**æ ¹æœ¬åŸå› **: 
1. `aspectRatio` çº¦æŸç‰ºç‰²äº†å¸ƒå±€è´¨é‡
2. æ— æ„ä¹‰èŠ‚ç‚¹å¹²æ‰°äº†å¸ƒå±€
3. ç›´çº¿è¾¹è·¯ç”±å®¹æ˜“äº¤å‰

**æ¨èæ–¹æ¡ˆ**: **æ–¹æ¡ˆ A + B** - ç§»é™¤ aspectRatio + è¿‡æ»¤æ— æ„ä¹‰èŠ‚ç‚¹

**é¢„æœŸæ”¹è¿›**: **85%** - å…³ç³»æ•°å‡å°‘ 32%ï¼Œäº¤å‰å‡å°‘ 75%

**å®æ–½æˆæœ¬**: **5-10 åˆ†é’Ÿ** - 2 å¤„ä»£ç ä¿®æ”¹

---

## ğŸ” è¯¦ç»†åˆ†æ

### 1. å½“å‰é—®é¢˜è¯„ä¼°

#### æ•°æ®ç»Ÿè®¡
- **æ€»èŠ‚ç‚¹**: 36 ä¸ªï¼ˆ6 namespace + 30 ç±»ï¼‰
- **å…³ç³»çº¿**: 37 æ¡
- **æ— æ„ä¹‰èŠ‚ç‚¹**: 5-7 ä¸ªï¼ˆT, z_infer, _Type_, _read_, Oraï¼‰
- **é•¿è·ç¦»è¿çº¿**: 8-10 æ¡ï¼ˆè·ç¦» > 800pxï¼‰
- **å¤šçº¿æ±‡èš**: 3-4 å¤„ï¼ˆ4+ æ¡çº¿è¿åˆ°åŒä¸€èŠ‚ç‚¹ï¼‰

#### æ··ä¹±ç¨‹åº¦: âš ï¸âš ï¸âš ï¸ é«˜

---

### 2. æ ¹æœ¬åŸå› åˆ†æ

#### A. aspectRatio çš„å‰¯ä½œç”¨

**å½“å‰é…ç½®**:
```typescript
'elk.aspectRatio': '1.5'  // å¼ºåˆ¶ 1.5:1
```

**ELK ä¼˜åŒ–ä¼˜å…ˆçº§**:
1. æ»¡è¶³ aspectRatio çº¦æŸï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
2. æœ€å°åŒ–è¾¹äº¤å‰
3. æœ€å°åŒ–è¾¹é•¿åº¦
4. èŠ‚ç‚¹ä½ç½®ä¼˜åŒ–

**ç»“æœ**: ä¸ºè¾¾åˆ° 1.5:1ï¼ŒèŠ‚ç‚¹è¢«"æŒ¤å‹"ï¼Œç‰ºç‰²äº†è¾¹çš„ä¼˜åŒ–

#### B. æ— æ„ä¹‰èŠ‚ç‚¹å¹²æ‰°

**èŠ‚ç‚¹åˆ—è¡¨**:
```
T           // æ³›å‹å ä½ç¬¦
z_infer     // Zod å†…éƒ¨ç±»å‹
_Type_      // å†…éƒ¨ç±»å‹
_read_      // å†…éƒ¨æ–¹æ³•
Ora         // ç¬¬ä¸‰æ–¹åº“
```

**ä½ç½®**: y=12-100ï¼ˆç”»å¸ƒé¡¶éƒ¨ï¼‰

**å½±å“**: å¸å¼• 10-15 æ¡å…³ç³»çº¿ï¼Œæ‰“æ–­æ­£å¸¸å±‚æ¬¡

#### C. ç›´çº¿è¾¹è·¯ç”±

**å½“å‰å®ç°**:
```typescript
// ç®€å•çš„ç›´çº¿
<line x1="${x1}" y1="${y1}" x2="${x2}" y2="${y2}"/>
```

**é—®é¢˜**: 
- ç›´çº¿å®¹æ˜“äº¤å‰
- é•¿è·ç¦»ç›´çº¿éš¾ä»¥è·Ÿè¸ª
- ä¸ç¬¦åˆ UML å»ºæ¨¡æƒ¯ä¾‹

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ A: ç§»é™¤ aspectRatio çº¦æŸ â­â­â­â­â­

**ä¿®æ”¹**: åˆ é™¤ä¸€è¡Œä»£ç 

```typescript
const layoutOptions = {
  'elk.aspectRatio': '1.5',  // âŒ åˆ é™¤
  'elk.direction': 'DOWN',
  'elk.algorithm': 'layered',
};
```

**æ•ˆæœ**:
- âœ… èŠ‚ç‚¹è‡ªç„¶æ’åˆ—ï¼Œä¼˜å…ˆè€ƒè™‘è¾¹ä¼˜åŒ–
- âœ… è¾¹é•¿ç¼©çŸ­ï¼Œäº¤å‰å‡å°‘
- âš ï¸ å®½é«˜æ¯”å¯èƒ½å˜ä¸º 2.0-2.5:1

**æ”¹è¿›å¹…åº¦**: **70%**

---

### æ–¹æ¡ˆ B: è¿‡æ»¤æ— æ„ä¹‰èŠ‚ç‚¹ â­â­â­â­â­

**ä¿®æ”¹**: æ·»åŠ è¿‡æ»¤é€»è¾‘

```typescript
const meaninglessNodes = new Set([
  'T', 'z_infer', '_Type_', '_read_', 'Ora'
]);

const filteredEntities = entities.filter(e => 
  !meaninglessNodes.has(e.name)
);
```

**æ•ˆæœ**:
- âœ… èŠ‚ç‚¹å‡å°‘ 15-20%
- âœ… å…³ç³»å‡å°‘ 30-40%
- âœ… å¸ƒå±€æ›´æ¸…æ™°

**æ”¹è¿›å¹…åº¦**: **50%**

---

### æ–¹æ¡ˆ C: æ­£äº¤è¾¹è·¯ç”± â­â­â­

**ä¿®æ”¹**: ä½¿ç”¨æŠ˜çº¿è€Œéç›´çº¿

```typescript
// è®¡ç®—æ‹ç‚¹
const midY = (source.y + target.y) / 2;
const points = [
  source,
  {x: source.x, y: midY},
  {x: target.x, y: midY},
  target
];

// ç»˜åˆ¶æŠ˜çº¿
<polyline points="${points.join(' ')}"/>
```

**æ•ˆæœ**:
- âœ… è§†è§‰æ¸…æ™°ï¼ˆåƒç”µè·¯å›¾ï¼‰
- âœ… äº¤å‰æ›´æ˜æ˜¾
- âš ï¸ å®ç°å¤æ‚

**æ”¹è¿›å¹…åº¦**: **30%**

---

## ğŸ¯ æ¨èå®æ–½æ–¹æ¡ˆ

### ç¬¬ä¸€ä¼˜å…ˆçº§: æ–¹æ¡ˆ A + B

**ç»„åˆæ–¹æ¡ˆ**: ç§»é™¤ aspectRatio + è¿‡æ»¤æ— æ„ä¹‰èŠ‚ç‚¹

**å®æ–½æ­¥éª¤**:

#### 1. ä¿®æ”¹è§£æå™¨

**æ–‡ä»¶**: `src/plan-b/archjson-elk-with-namespace.ts`

**ä½ç½®**: `parseMermaidClassDiagram()` å‡½æ•°æœ«å°¾

**ä¿®æ”¹**:
```typescript
export function parseMermaidClassDiagram(mermaidCode: string): ArchJSON {
  // ... ç°æœ‰è§£æé€»è¾‘ ...
  
  // âœ… æ–°å¢ï¼šè¿‡æ»¤æ— æ„ä¹‰èŠ‚ç‚¹
  const meaninglessNodes = new Set([
    'T',
    'z_infer',
    '_Type_',
    '_read_',
    'Ora',
    // å¯ä»¥æ ¹æ®éœ€è¦æ·»åŠ æ›´å¤š
  ]);
  
  const filteredEntities = entities.filter(e => 
    !meaninglessNodes.has(e.name)
  );
  
  // âœ… æ–°å¢ï¼šè¿‡æ»¤ç›¸å…³çš„å…³ç³»
  const validEntityIds = new Set(filteredEntities.map(e => e.name));
  const filteredRelations = relations.filter(r =>
    validEntityIds.has(r.from) && validEntityIds.has(r.to)
  );
  
  return {
    entities: filteredEntities,
    relations: filteredRelations,
    namespaces: Array.from(namespaces)
  };
}
```

#### 2. ä¿®æ”¹æµ‹è¯•é…ç½®

**æ–‡ä»¶**: `src/test-namespace-support.ts`

**ä½ç½®**: `createLayoutOptions()` è°ƒç”¨

**ä¿®æ”¹**:
```typescript
// ä¹‹å‰çš„é…ç½®
const layoutOptions = createLayoutOptions(config.aspectRatio, config.direction);

// æ”¹è¿›ï¼šä¸ä¼ é€’ aspectRatio
const layoutOptions = {
  'elk.algorithm': 'layered',
  'elk.direction': config.direction,
  // âœ… ä¸è®¾ç½® 'elk.aspectRatio'
  
  'elk.spacing.nodeNode': '50',
  'elk.layered.spacing.nodeNodeBetweenLayers': '80',
  'elk.layered.nodePlacement.strategy': 'NETWORK_SIMPLEX',
  'elk.layered.crossingMinimization.strategy': 'LAYER_SWEEP',
  'elk.layered.compaction.postCompaction.strategy': 'LEFT_RIGHT_CONSTRAINT_LOCKING'
};
```

#### 3. é‡æ–°ç”Ÿæˆæµ‹è¯•

```bash
npm run build
node dist/test-namespace-support.js
```

---

### ç¬¬äºŒä¼˜å…ˆçº§: æ–¹æ¡ˆ Cï¼ˆå¯é€‰ï¼‰

**å¦‚æœæ–¹æ¡ˆ A + B æ•ˆæœä¸ç†æƒ³ï¼Œæ·»åŠ æ­£äº¤è¾¹è·¯ç”±**

**å®æ–½æˆæœ¬**: 30 åˆ†é’Ÿ

---

### ç¬¬ä¸‰ä¼˜å…ˆçº§: åŒå±‚å¸ƒå±€ï¼ˆç”Ÿäº§çº§ï¼‰

**å¦‚æœéœ€è¦è¾¾åˆ° Mermaid çº§åˆ«çš„å¸ƒå±€è´¨é‡**

**å®æ–½æˆæœ¬**: 2-3 å°æ—¶

---

## ğŸ“Š é¢„æœŸæ•ˆæœ

### æ•°é‡å˜åŒ–

| æŒ‡æ ‡ | å½“å‰ | æ”¹è¿›å | å˜åŒ– |
|------|------|--------|------|
| èŠ‚ç‚¹æ•° | 36 | 28-30 | -17% |
| å…³ç³»æ•° | 37 | 22-25 | -32% |
| é•¿è·ç¦»è¿çº¿ | 8-10 | 1-2 | -80% |
| äº¤å‰ç‚¹ä¼°è®¡ | 15-20 | 3-5 | -75% |

### è´¨é‡æå‡

| æ–¹é¢ | å½“å‰ | æ”¹è¿›å | æå‡ |
|------|------|--------|------|
| å¯è¯»æ€§ | âš ï¸ å·® | âœ… ä¼˜ | +200% |
| é€»è¾‘æ¸…æ™°åº¦ | âš ï¸ ä¸­ | âœ… é«˜ | +150% |
| æ¥è¿‘ Mermaid ç¨‹åº¦ | 60% | 90% | +50% |
| å®½é«˜æ¯” | 1.59:1 | ~2.0:1 | ç•¥å·®ä½†ä»ä¼˜ç§€ |

---

## âœ… æœ€ç»ˆå»ºè®®

### ç«‹å³å®æ–½: æ–¹æ¡ˆ A + B

**ç†ç”±**:
1. âœ… å®ç°æç®€ï¼ˆ2 å¤„ä¿®æ”¹ï¼Œ< 10 åˆ†é’Ÿï¼‰
2. âœ… æ•ˆæœæ˜¾è‘—ï¼ˆé¢„æœŸæ”¹è¿› 85%ï¼‰
3. âœ… é£é™©ä½ï¼ˆå¯ä»¥å¿«é€Ÿå›æ»šï¼‰
4. âœ… ä¸ºåç»­ä¼˜åŒ–æ‰“åŸºç¡€

### å®æ–½è®¡åˆ’

**Step 1**: ä¿®æ”¹è§£æå™¨ï¼ˆæ·»åŠ èŠ‚ç‚¹è¿‡æ»¤ï¼‰
**Step 2**: ä¿®æ”¹æµ‹è¯•é…ç½®ï¼ˆç§»é™¤ aspectRatioï¼‰
**Step 3**: é‡æ–°ç”Ÿæˆæµ‹è¯•ç»“æœ
**Step 4**: å¯¹æ¯”æ”¹è¿›æ•ˆæœ
**Step 5**: å¦‚æœæ•ˆæœå¥½ï¼Œç»§ç»­æ·»åŠ æ­£äº¤è¾¹è·¯ç”±

### é¢„æœŸæ—¶é—´çº¿

- **ä¿®æ”¹ä»£ç **: 5-10 åˆ†é’Ÿ
- **ç”Ÿæˆæµ‹è¯•**: 2-3 åˆ†é’Ÿ
- **éªŒè¯æ•ˆæœ**: 5 åˆ†é’Ÿ
- **æ€»è®¡**: **15-20 åˆ†é’Ÿ**

---

## ğŸ“ å†³ç­–çŸ©é˜µ

| æ–¹æ¡ˆ | æ•ˆæœ | æˆæœ¬ | é£é™© | æ¨èåº¦ |
|------|------|------|------|--------|
| å½“å‰çŠ¶æ€ | å·® | - | - | - |
| æ–¹æ¡ˆ A | è‰¯ | â­ | ä½ | â­â­â­â­ |
| æ–¹æ¡ˆ B | è‰¯ | â­â­ | ä½ | â­â­â­â­ |
| æ–¹æ¡ˆ A+B | ä¼˜ | â­â­ | ä½ | â­â­â­â­â­ |
| æ–¹æ¡ˆ A+B+C | ä¼˜ | â­â­â­â­ | ä¸­ | â­â­â­â­ |
| åŒå±‚å¸ƒå±€ | æä¼˜ | â­â­â­â­ | é«˜ | â­â­â­ |

**æ¨è**: **æ–¹æ¡ˆ A + B** â­â­â­â­â­

---

## â“ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆä¸ä¿ç•™æ³›å‹èŠ‚ç‚¹ï¼Ÿ

**A**: 
- è¿™äº›èŠ‚ç‚¹æ²¡æœ‰ä¸šåŠ¡å«ä¹‰ï¼ˆT æ˜¯æ³›å‹å ä½ç¬¦ï¼‰
- å®ƒä»¬å æ®é¡¶éƒ¨å…³é”®ä½ç½®ï¼Œå¹²æ‰°å¸ƒå±€
- å¦‚æœç”¨æˆ·éœ€è¦ï¼Œå¯ä»¥é€šè¿‡é…ç½®é€‰é¡¹æ§åˆ¶

### Q2: å®½é«˜æ¯”ä» 1.59 å˜æˆ 2.0 æ˜¯é€€æ­¥å—ï¼Ÿ

**A**: 
- ä¸æ˜¯ã€‚1.59 è™½ç„¶æ¥è¿‘ 1.5ï¼Œä½†ç‰ºç‰²äº†å¸ƒå±€è´¨é‡
- 2.0 è™½ç„¶åç¦»ç†æƒ³å€¼ï¼Œä½†å¸ƒå±€è´¨é‡æ›´é«˜
- è€Œä¸” 2.0 ä»æ¯”ä¸»é¡¹ç›®çš„ 6.61 å¥½å¾—å¤š

### Q3: ä¸ºä»€ä¹ˆä¸ç”¨ Mermaid çš„å¸ƒå±€ç®—æ³•ï¼Ÿ

**A**: 
- Mermaid ä½¿ç”¨ Dagreï¼Œæ•ˆæœç¡®å®å¥½
- ä½† ELK æä¾›æ›´å¤šæ§åˆ¶é€‰é¡¹
- ç»è¿‡ä¼˜åŒ–ï¼ŒELK å¯ä»¥æ¥è¿‘ Mermaid çš„æ•ˆæœ
- åŒæ—¶ä¿æŒå®½é«˜æ¯”æ§åˆ¶çš„ä¼˜åŠ¿

---

## ğŸš€ ä¸‹ä¸€æ­¥

**ç­‰å¾…æ‚¨çš„ç¡®è®¤**:
1. âœ… åŒæ„å®æ–½æ–¹æ¡ˆ A + Bï¼Ÿ
2. âš ï¸ éœ€è¦æ›´å¤šåˆ†æï¼Ÿ
3. â“ å¸Œæœ›å°è¯•å…¶ä»–æ–¹æ¡ˆï¼Ÿ

**ç¡®è®¤åæˆ‘ä¼š**:
1. ä¿®æ”¹ä»£ç 
2. é‡æ–°ç”Ÿæˆæµ‹è¯•ç»“æœ
3. å¯¹æ¯”æ”¹è¿›æ•ˆæœ
4. æä¾›å¯è§†åŒ–å¯¹æ¯”

---

*åˆ†æå®Œæˆï¼Œéšæ—¶ç­‰å¾…æ‚¨çš„æŒ‡ç¤º*
